# Cycle 0004 — PR reviewers+classification+emails; for('each')+spelled numbers; docs+man; notes on NL windows (2025-09-06T15-57-53)

1. Summary

- Problem/intent:
  - Enrich commit→GitHub PR data with reviewers[], approver, user classification, and email (best‑effort) while preserving stable JSON contracts. Expand `--for` language to accept “each …” synonyms and spelled numbers (1–12) for month/week buckets. Update docs/man accordingly. Capture notes for a robust NL recurrence approach.
- Deliverables (code/docs/tests):
  - Code: enrichment for reviewers/approver/classification/email; `--for` parser tweaks; no schema changes.
  - Tests: env‑seam tests for enrichment (approver/reviewers/emails/classification); parser tests for “each …” and spelled numbers.
  - Docs: README + man updates (summary shape, `report_options`, out‑dir semantics, progress logs, user type mapping, email caveats).
- Scope (modules/files/areas):
  - `src/enrichment/github_api.rs`, `src/enrichment/github_pull_requests.rs`, `src/commit.rs` (no shape changes), `src/range_windows.rs` (parser), `tests/integration/*`, `README.md`, `docs/man`.

2. Context & Constraints

- Domain context: Git activity → JSON feeds for report‑writer agents; additive enrichment only.
- Consumers: human operators + downstream agents expecting stable shapes; CI enforces schemas/spacing/headers.
- External contracts: GitHub REST v3; presence of GITHUB_TOKEN or gh fallback is best‑effort; JSON schema remains unchanged.
- Constraints: No breaking schema changes; additive fields already exist (reviewers/approver optional). Follow spacing/layout/guard rules.

3. State & Invariants

- State variables: repo origin (owner/name), token, commit set, per‑PR detail cache, per‑login user cache.
- Derived state: unique PR numbers per commit; deduped reviewers.
- Invariants:
  - Classification mapping: {bot|member|contributor|other|unknown}; “unknown” when API unavailable; “bot” if login ends with [bot] or user.type==Bot; “member” when author_association ∈ {OWNER,MEMBER,COLLABORATOR}; “contributor” when ∈ {CONTRIBUTOR,FIRST_TIME_CONTRIBUTOR,FIRST_TIMER}; “other” otherwise.
  - Reviewers deduped by login; stable order by login.
  - Approver = latest APPROVED review by submitted_at; fallback merged_by; else None.
  - Email best‑effort: prefer user profile email; fallback from PR commits; else None.

4. Inputs → Outputs (Contracts)

- Inputs: `--repo`, `--for`, `--tz`, `--out`; env: `GITHUB_TOKEN` (or `gh auth token`), test seams (`GAR_TEST_*`).
- Outputs: Same report/manifest shapes; commit.github.pull_requests[*] enriched with `submitter`, `reviewers[]`, `approver`; user fields {login, profile_url, type, email} populated best‑effort.
- Contracts: No new required fields; all additions are optional. Pointer outputs and filenames unchanged.

5. Orchestration Plan (Phases)

- Phase 1 — Normalize/build inputs: parse CLI; resolve origin/token.
- Phase 2 — Resolve/derive: ranges; identify unique PR numbers per commit.
- Phase 3 — Process units: fetch PR details+reviews+commits; build submitter/reviewers/approver with classification+emails; attach to commits.
- Finalize — unchanged: render report, write per mode; zero‑commit behavior preserved.

6. Module/Boundary Plan

- Resolution/parser: `range_windows.rs` — accept “each” and spelled numbers (1–12) for week/month bucketters.
- Processing/orchestrator: `range_processor.rs` — no changes.
- Rendering: `render.rs` — no changes.
- Persistence/manifest: no changes.
- Enrichment/integration:
  - `github_api.rs`: add `get_user_json(login)` to trait; env seam for user JSON; classify helper (login + gh_json + association).
  - `github_pull_requests.rs`: build reviewers/approver/emails; dedupe and attach to `commit.github.pull_requests` per commit.
- Utilities: small helpers for user type classification and email sourcing.

7. Side Effects & IO

- Filesystem: unchanged.
- Network: GitHub REST calls (best‑effort; skip silently without token); bounded by per‑PR fanout: details + reviews + commits + optional user lookup per unique login.
- Subprocess: optional `gh auth token` fallback.
- Concurrency: keep sequential; consider batching/caching if needed.

8. Testing & Validation

- Unit: classifier mapping; email extraction precedence.
- Contract: schemas unchanged; existing validators must pass.
- Integration: env‑seam tests for reviewers/approver and user email/type; for‑phrases tests for “each …” and spelled numbers.
- Manual: run against a GitHub repo with token; spot‑check reviewer counts and emails.

9. Risks & Trade-offs

- Performance: additional API calls; mitigate via per‑PR fetch once + per‑login user cache.
- Data quality: public email often None; fallback via commit authors helps but not guaranteed.
- Robustness: rate limits; handle by best‑effort and “unknown” type when unavailable.
- Backward compatibility: maintained (all fields optional).

10. Tie‑Breakers

1) Contract stability (filenames/schemas/protocols)
2) Orchestration simplicity (single loop, explicit state)
3) Correctness/testability (pure helpers, invariants)
4) Performance (avoid duplicate heavy work)
5) Minimal diff/readability

11. Observability & Rollback

- Logs: existing stderr progress lines; keep current `[github]` warnings for missing token/non‑GitHub origin.
- Evidence: snapshot/integration tests show reviewer/approver presence; output pointers unchanged.
- Rollback: enrichment is best‑effort; disabling GitHub token reverts to baseline without breaking output.

12. Cycle Metadata

- Cycle id: 0004
- Short description: PR reviewers+classification+emails; for('each')+spelled numbers; docs+man; notes on NL windows
- Timestamp: start 2025-09-06T15:57:53 local; end: TBD
- Links: FEEDBACK.md; CONTEXT_RESET.md; NLP_DATE_WINDOWS.md

---

Notes on NLP Date Windows (next‑cycle research)

- Prefer “NL parse → RRULE build → rrule expansion” architecture.
- Candidates: rustling‑ontology (rich, heavy build), timewarp (lighter), chrono‑english (already used; keep for base phrases), minimal pest/nom grammar for constrained patterns.
- Spelled numbers: start with 1–12; evaluate library solutions next.
- Timezone: keep DTSTART in chrono‑tz to avoid DST anomalies; rrule yields localized occurrences.

---

## Work Reports

- 2025-09-06 — Plan and mapping to feedback
  - Recorded at (local): 2025-09-06T16:32:15-0500
  - Summarized CONTEXT_RESET.md and FEEDBACK.md, mapped implemented items vs. remaining work. Proposed a plan to populate reviewers/approver (dedupe + classification), accept “each” and spelled numbers for `--for`, update docs/man, run local gates, and asked clarifying questions on user type mapping, spelled numbers scope, and manifest expectations.

- 2025-09-06 — Decisions incorporated and next cycle scope
  - Recorded at (local): 2025-09-06T16:32:15-0500
  - Captured decisions: classification values (bot|member|contributor|other, and unknown when API unavailable) and that email population should not be skipped. Outlined enrichment flow (PR details, reviews, commits, user profiles), natural‑language expansion, docs, and CI steps, plus optional additive metrics.

- 2025-09-06 — Cycle scaffolded
  - Recorded at (local): 2025-09-06T16:32:15-0500
  - Created cycle 0004 with Summary, Constraints, Invariants, Module Plan, Testing, Risks, and embedded notes from NLP_DATE_WINDOWS.md. Noted a macOS `mapfile` hiccup and proceeded by writing the file directly.

- 2025-09-06 — Implementation status report
  - Recorded at (local): 2025-09-06T16:32:15-0500
  - Implemented reviewers/approver enrichment, user classification with `unknown`, email best‑effort (profile → commit), PR metrics (review/approval/change counts; time_to_first_review; time_to_merge), extended `--for` to accept “each”+spelled numbers for weeks/months, and updated README. Provided verification instructions (env seams, commands) and next steps (run gates, open PR, optional metrics/rollups).

- 2025-09-06 — Dead‑code hygiene cleanup
  - Recorded at (local): 2025-09-06T16:32:15-0500
  - Removed `#[allow(dead_code)]` usages and replaced with targeted `#[cfg(any(test, feature = "testutil"))]` gating; explained rationale and guidelines. Verified builds clean.

- 2025-09-06 — Policy + refactor confirmation
  - Recorded at (local): 2025-09-06T16:32:15-0500
  - Added AGENTS.md guidance discouraging `allow(dead_code)` without explicit approval and requiring in‑line justification. Moved `diff_seconds` into `src/util.rs` and updated call sites.
