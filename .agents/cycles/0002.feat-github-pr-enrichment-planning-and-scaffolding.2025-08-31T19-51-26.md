# Cycle 0002 — feat: GitHub PR enrichment planning and scaffolding (2025-08-31T19-51-26)


Use this template before editing code. Keep it short and decisive. Save a copy as `$GITROOT/.agents/cycles/<idx>.<short-desc>.<timestamp>.md` to log each cycle.

1) Summary

- Problem/intent: Add GitHub Pull Request enrichment to correlate commits with PRs; expose an aggregated `pull_requests` array with per-PR commit snapshots and duration metrics; isolate GitHub API calls.
- Deliverables (code/docs/tests): Rust modules for GitHub API + aggregator, model extensions, render integration, cycle log; build passes and all tests green.
- Scope (modules/files/areas): src/enrichment/github_api.rs, src/enrichment/github_pull_requests.rs, src/enrich.rs, src/model.rs, src/render.rs, Cargo.toml, scripts/new_cycle.sh.

2) Context & Constraints

- Domain context (what system does): Export Git activity to JSON (single/sharded) for downstream report generation.
- Primary consumers (humans/services): LLM-driven report writer agent reading JSON artifacts.
- External contracts (APIs/schemas/CLIs): GitHub REST v3 (`/commits/{sha}/pulls`, `/pulls/{number}`, `/pulls/{number}/commits`), JSON Schemas (Draft 2020-12), CLI flags, shard and manifest naming conventions.

3) State & Invariants

- State variables (k: description): github_prs flag (enable enrichment), tz (label for local timestamps), split_apart (IO strategy), repo path.
- Derived state (computed once): GitHub origin (owner/repo) and token (env or `gh`); PR numbers per-report; pull_requests aggregation.
- Invariants (pre/post, must always hold): No schema breaking changes; optional fields only. Best-effort enrichment (no panics, no hard failures). Stable filenames and pointer shapes retained.

4) Inputs → Outputs (Contracts)

- Inputs (flags, env, APIs, files): `--github-prs` (or `--detailed`), `GITHUB_TOKEN` or `gh auth token`, repo’s `remote.origin.url`.
- Outputs (files, API responses, console): Report JSON gains optional `pull_requests` (deduped across commits); per-commit `github_prs` remains. Advisory warnings to stderr when origin/token unavailable.
- Naming/shape contracts (stable filenames/paths; schema versions; pointer shapes): Shards `YYYY.MM.DD-HH.MM-<shortsha>.json`, manifests `manifest-YYYY-MM.json` and `manifest.json` unchanged; JSON fields additive and optional; timestamps unchanged.

5) Orchestration Plan (Phases)

- Phase 1 — Normalize/build inputs: Normalize CLI to EffectiveConfig; decide flags; resolve repo path.
- Phase 2 — Resolve/derive: Detect GitHub origin; acquire token (env → gh); derive PR numbers from per-commit enrichment.
- Phase 3 — Process units (loop): generate commits → save shards (if split) → index items/authors.
- Finalize — aggregate/manifest → emit/return: Aggregate PRs into `pull_requests`, compute durations, attach commits list, write report/manifest as usual.

6) Module/Boundary Plan

- Resolution/parser module(s): cli.rs, range_windows.rs (unchanged).
- Processing/orchestrator module(s): range_processor.rs, render.rs (integration point for aggregated PRs).
- Assembly/rendering module(s): render.rs (sets `pull_requests` when enabled).
- Persistence/manifest module(s): manifest.rs (unchanged outputs).
- Enrichment/integration module(s): enrichment/github_pull_requests.rs (per-commit + aggregator), enrichment/github_api.rs (origin/token/REST).
- Utilities/helpers: ext/serde_json (JsonFetch), util.rs (git/run/time helpers).

7) Side Effects & IO

- Filesystem (paths, write strategy): Same as before; optional patch files saved if requested.
- Network/API calls (best-effort vs. required): Best-effort; skip silently for per-commit; aggregate warns once if origin/token missing.
- Subprocess/system calls: `gh auth token` when `GITHUB_TOKEN` absent.
- Concurrency decisions: Sequential calls (low volume); can batch/paginate later if needed.

8) Testing & Validation

- Unit tests (pure helpers): Existing tests pass; duration parser uses time::parsing; ext::serde_json used to fetch fields safely.
- Contract tests (schemas/pointers/naming): Existing schema tests pass; new fields are optional; no schema breakage.
- Integration tests (end-to-end scenarios): Full suite green; PR network logic best‑effort and gated by flags/tokens.
- Manual checks (smoke/paths/outputs): Verify `--github-prs` adds `pull_requests` when token available; stderr advisories when missing.

9) Risks & Trade-offs

- Purity vs. performance: Sequential network calls chosen for clarity; acceptable volume; can optimize with caching/pagination later.
- Stability vs. ergonomics: Optional fields prevent schema breakage; warnings instead of hard failures.
- Backward compatibility/migration: Additive only; existing consumers unaffected when `--github-prs` is off.

10) Tie-Breakers (apply in this order)

1. Contract stability (filenames/schemas/protocols)
2. Orchestration simplicity (single loop, explicit state)
3. Correctness/testability (pure helpers, invariants)
4. Performance (avoid duplicate heavy work)
5. Minimal diff/readability

11) Observability & Rollback

- Logs/metrics/counters: Single stderr advisories for missing token/origin at aggregation layer.
- Pointer/evidence to outputs: Report JSON contains `pull_requests` with `commits[]` and `duration_seconds` when enabled.
- Rollback plan: Disable `--github-prs` flag or revert module wiring; no persisted migrations.

12) Cycle Metadata

- Cycle id: 0002
- Short description: GitHub PR enrichment planning and scaffolding
- Timestamp (start/end): 2025-08-31T19-51-26 / 2025-08-31T20-05-00
- Links (PR/issues): n/a (local cycle)


---
Repo Overlay (autogenerated skeleton)

States (define enumerated program states here):
- [fill: e.g., single, multi, write, preview, split, monolithic]

Modules → Roles (from file headers):
- src/commit.rs: commit construction/enrichment — Construct per-commit objects; enrich with optional PR links; embed or save patches as configured
- src/util.rs: utilities/helpers — Utilities for paths, time formatting, spacing-safe helpers, and man page rendering
- src/render.rs: assembly/render — Assemble per-range reports; when split_apart, write commit shards and per-range report, returning a pointer
- src/manifest.rs: persistence/manifest — Build and write overall manifest for multi-range runs
- src/params.rs: parameter mapping — Translate EffectiveConfig + [since,until] into ReportParams for render
- src/main.rs: entrypoint/orchestrator — Entrypoint orchestrator; normalize → resolve ranges → process ranges; print final JSON or pointer
- src/enrichment/github_pull_requests.rs: enrichment/integration — Best-effort enrichment adding GitHub PR links and PR list to a commit
- src/range_windows.rs: resolution/parser — Resolve time windows into labeled ranges; parse "now" overrides; helpers for natural language buckets
- src/range_processor.rs: processing/orchestrator — Orchestrate per-range processing: generate report JSON and save artifacts; assemble overall manifest for multi-range runs
- src/cli.rs: cli/normalization — Parse CLI flags and produce an EffectiveConfig with consistent defaults and implied flags

Module Outputs (from file headers):
- src/commit.rs → Commit structs with files/diffstat/patch_ref; optional patch text and saved patch files
- src/util.rs → Canonicalized paths, formatted timestamps, directories ensured, man page text
- src/render.rs → SimpleReport JSON (non-split) or pointer {dir, file} (split)
- src/manifest.rs → manifest.json file written under base_dir
- src/params.rs → ReportParams with label, flags, out dir decisions
- src/main.rs → Either full JSON to stdout, or a pointer {dir,file}/{dir,manifest} to stdout; files on disk when split/multi
- src/enrichment/github_pull_requests.rs → Mutated commit.patch_ref (diff/patch URLs) and commit.github_prs
- src/range_windows.rs → Vec<LabeledRange> (chronological earliest→latest); parsed DateTime for now when requested
- src/range_processor.rs → Files on disk (reports, shards), optional manifest.json; stdout pointer or JSON per state
- src/cli.rs → EffectiveConfig with normalized paths and flags; multi_windows is initialized false (set later)

Module Invariants (from file headers):
- src/commit.rs
  - clip_patch preserves UTF-8 boundaries; patch_clipped is accurate
  - body_lines derived when body is non-empty
  - enrichment is best-effort; absence of PRs leaves fields None
- src/util.rs
  - prepare_out_dir returns an existing directory (either provided or temp timestamped)
  - clip_patch never splits UTF-8; indicates clipping accurately
  - format_shard_name pattern is stable and locale-independent
- src/render.rs
  - run_simple returns fully in-memory report consistent with schema
  - run_report returns pointer JSON when split; otherwise full report JSON; file names are stable
  - shard filenames follow YYYY.MM.DD-HH.MM-<shortsha>.json
- src/manifest.rs
  - manifest contains ranges[] in chronological order of entries provided
  - file paths in entries are relative to base_dir and point to report-<label>.json
  - generated_at is serialized in %Y-%m-%dT%H:%M:%S (local)
- src/params.rs
  - label derives from window type (Month => ym; else "window") unless overridden later
  - split_out is set when out != "-"; otherwise resolved by render
- src/main.rs
  - when cfg.multi_windows == true, an overall manifest.json is written and a pointer with {dir, manifest} is printed
  - when cfg.split_apart == true and cfg.multi_windows == false, a pointer {dir, file} is printed for the range report
  - when cfg.split_apart == false and cfg.multi_windows == false, a full JSON report is printed to stdout or written to --out
- src/enrichment/github_pull_requests.rs
  - On success, preserves existing commit fields; sets URLs if present in first PR; attaches PR list
  - On failure, commit remains valid; fields untouched
- src/range_windows.rs
  - resolve_ranges returns at least one range; ForPhrase buckets are ordered earliest→latest
  - month_bounds yields [start_of_month, start_of_next_month]
  - parse_now accepts RFC3339 or naive %Y-%m-%dT%H:%M:%S and never panics
- src/range_processor.rs
  - base_dir is prepared when split_apart || multi_windows
  - per-range report file name is report-<label>.json when written to disk
  - multi_windows ⇒ manifest.json exists and pointer {dir, manifest} printed
  - single split ⇒ pointer {dir, file} printed; single non-split ⇒ JSON printed or written to --out
- src/cli.rs
  - exactly one window selection is provided: --month | --for | (--since & --until)
  - --detailed implies include_unmerged/include_patch/github_prs
  - out semantics: file path when single non-split; directory when split or multi

Acceptance (checklist to adapt):
- [ ] Program state derived once and stored centrally
- [ ] Outputs mapped to enumerated states
- [ ] Names/shapes stable and test-covered
- [ ] Orchestrator phases clear; IO at edges
- [ ] Invariants defined and asserted
- [ ] Errors include what/where
- [ ] Observability: pointers/ids/paths logged/printed

Cycle Metadata (prefilled)

- Cycle id: 0002
- Short description: feat: GitHub PR enrichment planning and scaffolding
- Timestamp: 2025-08-31T19-51-26
- File: /Users/james/Projects/git-activity-report/.agents/cycles/0002.feat-github-pr-enrichment-planning-and-scaffolding.2025-08-31T19-51-26.md
