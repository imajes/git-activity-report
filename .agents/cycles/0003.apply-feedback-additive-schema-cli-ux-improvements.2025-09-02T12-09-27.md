# Cycle 0003 — Apply feedback: additive schema + CLI UX improvements (2025-09-02T12-09-27)

1) Summary

- Problem/intent: Address FEEDBACK.md by adding requested JSON fields and UX fixes while preserving existing contracts (additive changes only). Improve timezone handling, GitHub metadata, output directory behavior, `--for` parsing robustness, and optional progress reporting.
- Deliverables (code/docs/tests): Model additions, enrichment updates, CLI flag(s), `--for` parser improvements, safer output handling, optional progress logs, tests for new helpers/parsers, docs updates. Each area lands as its own commit with a detailed message.
- Scope (modules/files/areas): model.rs, commit.rs, enrichment/github_*; render.rs, range_processor.rs, range_windows.rs, cli.rs, util.rs, tests/*, README/AGENTS notes.

2) Context & Constraints

- Domain: CLI exports Git activity to JSON (single or split-apart) for downstream automation and human reporting.
- Consumers: external report-writer agent and humans; schemas under tests/schemas enforce shape. Changes must be additive.
- Constraints: Do not break existing schemas/consumers. Keep module headers, spacing/layout rules. Treat clippy warnings as errors.

3) State & Invariants

- State vars: split_apart, multi_windows, tz selection, include flags, out path, now_override.
- Derived state: base_dir when split/multi; label per range; pointer prints for split/multi.
- Invariants: filenames stable; existing schema fields untouched; additive fields only. Orchestrator single loop; IO at edges.

4) Inputs → Outputs (Contracts)

- Inputs: CLI flags (including new `--tz-name` and `--progress`), repo origin, GH token (optional).
- Outputs: unchanged primary contracts (report JSON, shard files, overall manifest). Additive fields: commit.patch_lines, commit.patch_references.github{commit_url,diff_url,patch_url}, commit.github.pull_requests (alias to existing), PR.body_lines/reviewers/approver, GithubUser profile_url/type/email, report.report_options, report.range_info, optional changeset alias.
- Contract rule: retain legacy fields (timestamps.timezone, patch_ref, github_prs, summary, range) for back‑compat.

5) Orchestration Plan (Phases)

- Phase 1 — Normalize/build: accept `--tz-name` (optional), `--progress`; keep `--tz` for local/utc. No behavior change to state machine.
- Phase 2 — Resolve/derive: timezone name resolution; robust `--for` phrase parsing (“each/every”, spelled numbers); compute GitHub commit URLs from origin when GitHub.
- Phase 3 — Process units: build commit objects with new additive fields; enrich PRs with body_lines, reviewers, approver; write shards; ensure parent dirs for single‑file outputs; treat directory `--out` gracefully.
- Finalize — aggregate/manifest: unchanged; print pointers; optionally error on empty window behind a flag.

6) Module/Boundary Plan

- model.rs: add structs/fields (PatchReferences, GithubMetadata, GithubUser extras, PR body_lines/reviewers, Commit.patch_lines, Commit.patch_references, Commit.github alias).
- commit.rs: populate patch_lines; derive body_lines (exists); fill patch_references.github URLs; keep patch_ref.
- enrichment/github_api.rs: helper to compute commit URLs; extend reviews aggregation to reviewers; surface GH user `type` and html_url → profile_url.
- enrichment/github_pull_requests.rs: map PR.body → body_lines; set approver (exists) and reviewers; populate submitter.
- util.rs: add iso_in_tz_named(tz_name) using chrono-tz; ensure_parent_dir(path) for single-file writes.
- cli.rs/params.rs: add `--tz-name` (string) and `--progress`; plumb into EffectiveConfig/ReportParams; derive tz choice.
- range_windows.rs: accept “each/every … last N” patterns and small spelled numbers; keep existing flows.
- range_processor.rs/render.rs: add report_options/range_info into report; ensure parent dir for `--out` file; treat directory `--out` as base + default file name; optional fail-on-empty flag behavior.

7) Side Effects & IO

- Filesystem: mkdir parent for file outputs; retain existing dir strategies; progress logs go to stderr.
- Network: unchanged endpoints; additional reviewers list from reviews endpoint (already used for approver).
- Subprocess: `git config --get remote.origin.url` (existing); no new subprocesses.
- Concurrency: single-threaded as today.

8) Testing & Validation

- Unit: util::iso_in_tz_named; ensure_parent_dir; range_windows phrase parsing; GitHub URL builder.
- Contract: reuse existing schemas (additionalProperties allows new fields at commit/report level). No changes to timestamps schema.
- Integration: end-to-end for single non-split with directory `--out` (creates dir, writes file); empty-window behavior behind flag; split pointer unchanged.
- Manual: smoke run on fixture repo; validate printed pointers and file paths.

9) Risks & Trade-offs

- Backcompat: avoid breaking timestamps schema; add new fields elsewhere. Keep legacy fields alongside new ones.
- Ergonomics: add `--tz-name` instead of overloading `--tz` to avoid clap breakage; can unify later.
- Performance: negligible; reviews aggregation already present.

10) Tie-Breakers

1) Contract stability; 2) Orchestration simplicity; 3) Correctness; 4) Performance; 5) Minimal diffs.

11) Observability & Rollback

- Logs: optional progress to stderr; preserve existing eprintln! notices for GitHub enrichment skips.
- Evidence: pointers `{dir,file}`/`{dir,manifest}`; paths in manifest.
- Rollback: revert additive fields and flags without impacting legacy behavior.

12) Implementation Plan → Commit Groups

1. model: additive fields and types (Commit.patch_lines, patch_references, github alias, GithubUser extras, PR body_lines/reviewers) — no behavior yet.
2. commit/enrichment: populate new fields; compute GitHub commit URLs; reviewers aggregation; PR body_lines derivation.
3. CLI/timezone/util: add `--tz-name`; implement iso_in_tz_named; plumb tz name through; add report_options/range_info.
4. range_windows/UX: accept “each/every … last N” and small spelled numbers; treat directory `--out` and mkdir parents for file writes.
5. empty-window handling: add `--fail-on-empty`; when true and count==0, print JSON to stdout and exit non‑zero.
6. progress: `--progress` to stderr with coarse phases (resolve ranges → processing ranges → writing files).
7. docs/tests: README updates; unit/integration tests for new helpers and behaviors; run full CI suite.

---
Repo Overlay (autogenerated skeleton)

States (define enumerated program states here):
- [fill: e.g., single, multi, write, preview, split, monolithic]

Modules → Roles (from file headers):
- src/commit.rs: commit construction/enrichment — Construct per-commit objects; enrich with optional PR links; embed or save patches as configured
- src/gitio.rs: git/io-helpers — Provide thin, robust wrappers around `git` CLI to retrieve commit metadata, diffs, stats, and branch info for report generation
- src/util.rs: utilities/helpers — Utilities for paths, time formatting, spacing-safe helpers, and man page rendering
- src/render.rs: assembly/render — Assemble per-range reports; when split_apart, write commit shards and per-range report, returning a pointer
- src/ext/mod.rs: module/aggregation — Group extension traits and helpers for third-party crates and std types under a single `ext` namespace
- src/ext/serde_json.rs: extension/serde_json — Provide ergonomic nested JSON fetching via dotted paths and safe typed extraction for serde_json::Value
- src/enrich.rs: enrichment/coordinator — Coordinator to apply configured enrichments; keeps orchestration separate from enrichment implementations
- src/manifest.rs: persistence/manifest — Build and write overall manifest for multi-range runs
- src/params.rs: parameter mapping — Translate EffectiveConfig + [since,until] into ReportParams for render
- src/main.rs: entrypoint/orchestrator — Entrypoint orchestrator; normalize → resolve ranges → process ranges; print final JSON or pointer
- src/enrichment/github_api.rs: enrichment/github-api — Isolated GitHub API helpers used by enrichment (token discovery, REST calls)
- src/enrichment/github_pull_requests.rs: enrichment/integration — Best-effort enrichment adding GitHub PR links and PR list to a commit
- src/enrichment/mod.rs: enrichment/namespace — Namespace for enrichment features (GitHub PRs, etc.)
- src/range_windows.rs: resolution/parser — Resolve time windows into labeled ranges; parse "now" overrides; helpers for natural language buckets
- src/range_processor.rs: processing/orchestrator — Orchestrate per-range processing: generate report JSON and save artifacts; assemble overall manifest for multi-range runs
- src/model.rs: model/types — Define the JSON model (commits, ranges, manifests, GitHub PRs) shared by rendering and enrichment
- src/cli.rs: cli/normalization — Parse CLI flags and produce an EffectiveConfig with consistent defaults and implied flags

Module Outputs (from file headers):
- src/commit.rs → Commit structs with files/diffstat/patch_ref; optional patch text and saved patch files
- src/gitio.rs → Parsed commit meta, numstat/name-status, shortstat, patch text; branch names and ahead/behind/merged signals
- src/util.rs → Canonicalized paths, formatted timestamps, directories ensured, man page text
- src/render.rs → SimpleReport JSON (non-split) or pointer {dir, file} (split)
- src/ext/mod.rs → Re-exported submodules providing utility traits and helpers (e.g., JsonFetch)
- src/ext/serde_json.rs → JsonFetch trait and JsonFetched wrapper for typed extraction with defaults
- src/enrich.rs → Mutates Commit (per-commit enrichments) and returns optional aggregated enrichments for reports
- src/manifest.rs → manifest.json file written under base_dir
- src/params.rs → ReportParams with label, flags, out dir decisions
- src/main.rs → Either full JSON to stdout, or a pointer {dir,file}/{dir,manifest} to stdout; files on disk when split/multi
- src/enrichment/github_api.rs → JSON values and typed commit snapshots for PRs
- src/enrichment/github_pull_requests.rs → Mutated commit.patch_ref (diff/patch URLs) and commit.github_prs
- src/enrichment/mod.rs → Public submodules implementing specific enrichments
- src/range_windows.rs → Vec<LabeledRange> (chronological earliest→latest); parsed DateTime for now when requested
- src/range_processor.rs → Files on disk (reports, shards), optional manifest.json; stdout pointer or JSON per state
- src/model.rs → Serializable structs with stable field names and optional enrichment fields
- src/cli.rs → EffectiveConfig with normalized paths and flags; multi_windows is initialized false (set later)

Module Invariants (from file headers):
- src/commit.rs
  - clip_patch preserves UTF-8 boundaries; patch_clipped is accurate
  - body_lines derived when body is non-empty
  - enrichment is best-effort; absence of PRs leaves fields None
- src/util.rs
  - prepare_out_dir returns an existing directory (either provided or temp timestamped)
  - clip_patch never splits UTF-8; indicates clipping accurately
  - format_shard_name pattern is stable and locale-independent
- src/render.rs
  - run_simple returns fully in-memory report consistent with schema
  - run_report returns pointer JSON when split; otherwise full report JSON; file names are stable
  - shard filenames follow YYYY.MM.DD-HH.MM-<shortsha>.json
- src/manifest.rs
  - manifest contains ranges[] in chronological order of entries provided
  - file paths in entries are relative to base_dir and point to report-<label>.json
  - generated_at is serialized in %Y-%m-%dT%H:%M:%S (local)
- src/params.rs
  - label derives from window type (Month => ym; else "window") unless overridden later
  - split_out is set when out != "-"; otherwise resolved by render
- src/main.rs
  - when cfg.multi_windows == true, an overall manifest.json is written and a pointer with {dir, manifest} is printed
  - when cfg.split_apart == true and cfg.multi_windows == false, a pointer {dir, file} is printed for the range report
  - when cfg.split_apart == false and cfg.multi_windows == false, a full JSON report is printed to stdout or written to --out
- src/enrichment/github_api.rs
  - Never panic; return None/empty on failures (best-effort enrichment)
  - Token discovery prefers GITHUB_TOKEN, then `gh auth token`
  - Origin parser only recognizes GitHub remotes (https or ssh)
- src/enrichment/github_pull_requests.rs
  - On success, preserves existing commit fields; sets URLs if present in first PR; attaches PR list
  - On failure, commit remains valid; fields untouched
- src/range_windows.rs
  - resolve_ranges returns at least one range; ForPhrase buckets are ordered earliest→latest
  - month_bounds yields [start_of_month, start_of_next_month]
  - parse_now accepts RFC3339 or naive %Y-%m-%dT%H:%M:%S and never panics
- src/range_processor.rs
  - base_dir is prepared when split_apart || multi_windows
  - per-range report file name is report-<label>.json when written to disk
  - multi_windows ⇒ manifest.json exists and pointer {dir, manifest} printed
  - single split ⇒ pointer {dir, file} printed; single non-split ⇒ JSON printed or written to --out
- src/cli.rs
  - exactly one window selection is provided: --month | --for | (--since & --until)
  - --detailed implies include_unmerged/include_patch/github_prs
  - out semantics: file path when single non-split; directory when split or multi

Acceptance (checklist to adapt):
- [ ] Program state derived once and stored centrally
- [ ] Outputs mapped to enumerated states
- [ ] Names/shapes stable and test-covered
- [ ] Orchestrator phases clear; IO at edges
- [ ] Invariants defined and asserted
- [ ] Errors include what/where
- [ ] Observability: pointers/ids/paths logged/printed

Cycle Metadata (prefilled)

- Cycle id: 0003
- Short description: Apply feedback: additive schema + CLI UX improvements
- Timestamp: 2025-09-02T12-09-27
- File: /Users/james/Projects/git-activity-report/gar-rs/.agents/cycles/0003.apply-feedback-additive-schema-cli-ux-improvements.2025-09-02T12-09-27.md
