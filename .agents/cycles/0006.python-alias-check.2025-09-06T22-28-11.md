# Cycle 0006 — python alias check (2025-09-06T22-28-11)


Use this template before editing code. Keep it short and decisive. Save a copy as `$GITROOT/.agents/cycles/<idx>.<short-desc>.<timestamp>.md` to log each cycle.

1) Summary

- Problem/intent: Replace Bash-only cycle scaffolding with a portable Python tool, align the repo to use `python` (not `python3`), remove the legacy script, update docs/help, and fix the failing enrichment test to keep contracts stable.
- Deliverables (code/docs/tests):
  - scripts/new_cycle.py (new)
  - scripts/new_cycle_hook.sh (fallback to python; comment updates)
  - Justfile (_help expanded; new-cycle uses python)
  - AGENTS.md, prompt-engineering/AGENT_CYCLES.md, prompt-engineering/AGENTS_B.md (shell→python updates)
  - README.md (example: python ./prototype/...)
  - prototype/git-activity-report.py (shebang python)
  - src/enrichment/github_pull_requests.rs (fix: set commit patch URLs in seamed path)
  - Test run artifacts and coverage from `just test`
- Scope (modules/files/areas): scripts/, prompt-engineering/, README.md, Justfile, src/enrichment/github_pull_requests.rs.

2) Context & Constraints

- Domain context (what system does): Generate Git activity JSON reports with optional GitHub PR enrichment and support split/multi outputs.
- Primary consumers (humans/services): CLI users, downstream report-writer agents, CI.
- External contracts (APIs/schemas/CLIs): JSON Schemas in tests/schemas, GitHub REST (best-effort), `git` CLI, `just`, `python` (3.7+).

3) State & Invariants

- State variables (k: description):
  - effective_config.window (month|for|since/until)
  - effective_config.split_apart (bool)
  - effective_config.multi_windows (bool)
  - effective_config.include_patch (bool)
  - effective_config.include_github_prs (bool)
  - effective_config.out (path or "-")
- Derived state (computed once):
  - ReportParams { label, split decisions, base_dir }
  - Pointer objects {dir,file}|{dir,manifest}
  - Cycle paths: .agents/cycles/<idx>..., .agents/repo_overlay.json
- Invariants (pre/post, must always hold):
  - JSON shapes and filenames remain stable; no schema changes in this cycle
  - Patch URL fields in Commit.patch_references.github are present when origin is GitHub
  - No panics; enrichment is best-effort

4) Inputs → Outputs (Contracts)

- Inputs (flags, env, APIs, files): `just new-cycle "desc"`; env for enrichment tests (GAR_TEST_*), optional GITHUB_TOKEN.
- Outputs (files, API responses, console): New cycle file + overlay JSON; unchanged report schemas; seamed enrichment path now sets patch URLs.
- Naming/shape contracts: cycle filename `<idx>.<desc>.<ts>.md`; overlay JSON {repo,generated_at,modules[]}; shard pattern `YYYY.MM.DD-HH.MM-<shortsha>.json`.

5) Orchestration Plan (Phases)

- Phase 1 — Normalize/build inputs: Ported new-cycle to Python; updated shebangs and docs; switched calls to `python`.
- Phase 2 — Resolve/derive: Removed legacy Bash; updated hooks and help; verified cycle presence.
- Phase 3 — Process units: Fixed seamed enrichment to set commit/patch/diff URLs; ran test suite.
- Finalize — aggregate/manifest → emit/return: Completed cycle docs; confirmed `just _help` lists updated recipes.

6) Module/Boundary Plan

- Resolution/parser module(s): N/A (tooling only)
- Processing/orchestrator module(s): src/enrichment/github_pull_requests.rs (seamed enrich path)
- Assembly/rendering module(s): N/A
- Persistence/manifest module(s): N/A
- Enrichment/integration module(s): github_pull_requests (commit URL population)
- Utilities/helpers: scripts/new_cycle.py; Justfile help

7) Side Effects & IO

- Filesystem: writes .agents/cycles and .agents/repo_overlay.json; updates repo files.
- Network/API calls: none during tests (env-backed seams used).
- Subprocess/system: `git` for fixture repos; `cargo` for build/tests; `just` for commands.
- Concurrency decisions: default test runner behavior.

8) Testing & Validation

- Unit/integration: `just test` → all tests passing after fix (previous failure: seam_enrich_commit_with_env_api).
- Contract tests: JSON schema validation passed.
- Manual checks: `just new-cycle`, `bash scripts/check_cycle_presence.sh`, `just _help` output verified.
- Next local checks before PR: `just fmt`, `just clippy`, `just check-headers`, `just audit-spacing`, `just ci-check`.

9) Risks & Trade-offs

- python alias may map to Python 2 on some systems; mitigated by documenting requirement for Python 3.7+; local env is Python 3.12.
- Keeping only Python implementation reduces duplication; minimal risk due to straightforward port.
- Enrichment change touches only seamed path; no schema impact.

10) Tie-Breakers (apply in this order)

1. Contract stability (filenames/schemas/protocols)
2. Orchestration simplicity (single loop, explicit state)
3. Correctness/testability (pure helpers, invariants)
4. Performance (avoid duplicate heavy work)
5. Minimal diff/readability

11) Observability & Rollback

- Logs/metrics: print paths when creating cycle/overlay; nextest summary used for triage.
- Evidence: latest cycle and overlay JSON paths; test run output.
- Rollback: revert scripts/new_cycle.py replacement and the small enrichment change if needed.

12) Cycle Metadata

- Cycle id: 0006
- Short description: python alias check (plus: tooling port + failing test fix)
- Timestamp (start/end): 2025-09-06T22-28-11 / 2025-09-06T22:35:15
- Links (PR/issues): [local only]

---
Outcome

- Status: complete — Python cycle scaffolding in place; legacy Bash removed; docs/help updated; failing enrichment test fixed.
- Tests: `just test` passed; prior failure `seam_enrich_commit_with_env_api` resolved by setting commit patch/diff URLs in the seamed path.
- Artifacts: latest cycle file present; `.agents/repo_overlay.json` written.
- Schema/flags: no schema or flag changes.

Pre-PR Local Checks (run in order)

- `just fmt`
- `just clippy`
- `just audit-spacing`
- `just check-headers`
- `just ci-check`


---
Repo Overlay (autogenerated skeleton)

States (define enumerated program states here):
- [fill: e.g., single, multi, write, preview, split, monolithic]

Modules → Roles (from file headers):
- src/commit.rs: commit construction/enrichment — Construct per-commit objects; enrich with optional PR links; embed or save patches as configured
- src/gitio.rs: git/io-helpers — Provide thin, robust wrappers around `git` CLI to retrieve commit metadata, diffs, stats, and branch info for report generation
- src/util.rs: utilities/helpers — Utilities for paths, time formatting, spacing-safe helpers, and man page rendering
- src/render.rs: assembly/render — Assemble per-range reports; when split_apart, write commit shards and per-range report, returning a pointer
- src/enrich.rs: enrichment/coordinator — Coordinator to apply configured enrichments; keeps orchestration separate from enrichment implementations
- src/manifest.rs: persistence/manifest — Build and write overall manifest for multi-range runs
- src/params.rs: parameter mapping — Translate EffectiveConfig + [since,until] into ReportParams for render
- src/main.rs: entrypoint/orchestrator — Entrypoint orchestrator; normalize → resolve ranges → process ranges; print final JSON or pointer
- src/range_windows.rs: resolution/parser — Resolve time windows into labeled ranges; parse "now" overrides; helpers for natural language buckets
- src/range_processor.rs: processing/orchestrator — Orchestrate per-range processing: generate report JSON and save artifacts; assemble overall manifest for multi-range runs
- src/model.rs: model/types — Define the JSON model (commits, ranges, manifests, GitHub PRs) shared by rendering and enrichment
- src/cli.rs: cli/normalization — Parse CLI flags and produce an EffectiveConfig with consistent defaults and implied flags
- src/ext/mod.rs: module/aggregation — Group extension traits and helpers for third-party crates and std types under a single `ext` namespace
- src/ext/serde_json.rs: extension/serde_json — Provide ergonomic nested JSON fetching via dotted paths and safe typed extraction for serde_json::Value
- src/enrichment/github_api.rs: enrichment/github-api — Isolated GitHub API helpers used by enrichment (token discovery, REST calls)
- src/enrichment/github_pull_requests.rs: enrichment/integration — Best-effort enrichment adding GitHub PR links and PR list to a commit
- src/enrichment/mod.rs: enrichment/namespace — Namespace for enrichment features (GitHub PRs, etc.)

Module Outputs (from file headers):
- src/commit.rs → Commit structs with files/diffstat/patch_ref; optional patch text and saved patch files
- src/gitio.rs → Parsed commit meta, numstat/name-status, shortstat, patch text; branch names and ahead/behind/merged signals
- src/util.rs → Canonicalized paths, formatted timestamps, directories ensured, man page text
- src/render.rs → SimpleReport JSON (non-split) or pointer {dir, file} (split)
- src/enrich.rs → Mutates Commit (per-commit enrichments) and returns optional aggregated enrichments for reports
- src/manifest.rs → manifest.json file written under base_dir
- src/params.rs → ReportParams with label, flags, out dir decisions
- src/main.rs → Either full JSON to stdout, or a pointer {dir,file}/{dir,manifest} to stdout; files on disk when split/multi
- src/range_windows.rs → Vec<LabeledRange> (chronological earliest→latest); parsed DateTime for now when requested
- src/range_processor.rs → Files on disk (reports, shards), optional manifest.json; stdout pointer or JSON per state
- src/model.rs → Serializable structs with stable field names and optional enrichment fields
- src/cli.rs → EffectiveConfig with normalized paths and flags; multi_windows is initialized false (set later)
- src/ext/mod.rs → Re-exported submodules providing utility traits and helpers (e.g., JsonFetch)
- src/ext/serde_json.rs → JsonFetch trait and JsonFetched wrapper for typed extraction with defaults
- src/enrichment/github_api.rs → JSON values and typed commit snapshots for PRs
- src/enrichment/github_pull_requests.rs → Mutated commit.patch_ref (diff/patch URLs) and commit.github_prs
- src/enrichment/mod.rs → Public submodules implementing specific enrichments

Module Invariants (from file headers):
- src/commit.rs
  - clip_patch preserves UTF-8 boundaries; patch_clipped is accurate
  - body_lines derived when body is non-empty
  - enrichment is best-effort; absence of PRs leaves fields None
- src/util.rs
  - prepare_out_dir returns an existing directory (either provided or temp timestamped)
  - clip_patch never splits UTF-8; indicates clipping accurately
  - format_shard_name pattern is stable and locale-independent
- src/render.rs
  - run_simple returns fully in-memory report consistent with schema
  - run_report returns pointer JSON when split; otherwise full report JSON; file names are stable
  - shard filenames follow YYYY.MM.DD-HH.MM-<shortsha>.json
- src/manifest.rs
  - manifest contains ranges[] in chronological order of entries provided
  - file paths in entries are relative to base_dir and point to report-<label>.json
  - generated_at is serialized in %Y-%m-%dT%H:%M:%S (local)
- src/params.rs
  - label derives from window type (Month => ym; else "window") unless overridden later
  - split_out is set when out != "-"; otherwise resolved by render
- src/main.rs
  - when cfg.multi_windows == true, an overall manifest.json is written and a pointer with {dir, manifest} is printed
  - when cfg.split_apart == true and cfg.multi_windows == false, a pointer {dir, file} is printed for the range report
  - when cfg.split_apart == false and cfg.multi_windows == false, a full JSON report is printed to stdout or written to --out
- src/range_windows.rs
  - resolve_ranges returns at least one range; ForPhrase buckets are ordered earliest→latest
  - month_bounds yields [start_of_month, start_of_next_month]
  - parse_now accepts RFC3339 or naive %Y-%m-%dT%H:%M:%S and never panics
- src/range_processor.rs
  - base_dir is prepared when split_apart || multi_windows
  - per-range report file name is report-<label>.json when written to disk
  - multi_windows ⇒ manifest.json exists and pointer {dir, manifest} printed
  - single split ⇒ pointer {dir, file} printed; single non-split ⇒ JSON printed or written to --out
- src/cli.rs
  - exactly one window selection is provided: --month | --for | (--since & --until)
  - --detailed implies include_unmerged/include_patch/github_prs
  - out semantics: file path when single non-split; directory when split or multi
- src/enrichment/github_api.rs
  - Never panic; return None/empty on failures (best-effort enrichment)
  - Token discovery prefers GITHUB_TOKEN, then `gh auth token`
  - Origin parser only recognizes GitHub remotes (https or ssh)
- src/enrichment/github_pull_requests.rs
  - On success, preserves existing commit fields; sets URLs if present in first PR; attaches PR list
  - On failure, commit remains valid; fields untouched

Acceptance (checklist to adapt):
- [ ] Program state derived once and stored centrally
- [ ] Outputs mapped to enumerated states
- [ ] Names/shapes stable and test-covered
- [ ] Orchestrator phases clear; IO at edges
- [ ] Invariants defined and asserted
- [ ] Errors include what/where
- [ ] Observability: pointers/ids/paths logged/printed

Cycle Metadata (prefilled)

- Cycle id: 0006
- Short description: python alias check
- Timestamp: 2025-09-06T22-28-11
- File: .agents/cycles/0006.python-alias-check.2025-09-06T22-28-11.md
